<Window x:Class="RackMonitor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:RackMonitor"
        xmlns:vm="clr-namespace:RackMonitor.ViewModels"
        xmlns:usercontrols="clr-namespace:RackMonitor.UserControls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        mc:Ignorable="d"
        Title="Rack Monitor" Height="900" Width="1500"
        x:Name="RackWindow">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/MainWindowStyles.xaml"/>
                <ResourceDictionary Source="/Resources/RackUnitDataTemplate.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <ControlTemplate x:Key="ContentOnlyTemplate" TargetType="{x:Type Button}">
                <ContentPresenter />
            </ControlTemplate>

        </ResourceDictionary>
    </Window.Resources>
    <DockPanel Background="{StaticResource PanelBackgroundBrush}">

        <!-- Main Layout Grid -->
        <Grid Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <!-- Column 0: Holds Settings Panel OR Open Button -->
                <ColumnDefinition Width="*"/>
                <!-- Column 1: Holds Main Rack Content -->
                <ColumnDefinition Width="Auto"/>
                <!-- NEW Column 2: Holds Details Panel -->
            </Grid.ColumnDefinitions>
            <!-- REMOVED Grid.RowDefinitions -->

            <!-- Column 0 Content: A Grid to hold the "Open" button -->
            <Grid Grid.Column="0">
                <Button Style="{StaticResource OpenSettingsButtonStyle}"/>
            </Grid>

            <!-- Settings Panel (Column 0) -->
            <Border Grid.Column="0" BorderBrush="{StaticResource BorderBrush}" BorderThickness="2" CornerRadius="5" Background="{StaticResource BorderBrush}" Padding="10" Width="250">
                <!-- REMOVED Grid.RowSpan="2" -->
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding DataContext.IsSettingsPanelOpen, ElementName=RackWindow}" Value="False">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <StackPanel>
                    <!-- ... (Settings Panel Content remains the same) ... -->
                    <!-- Settings Label and Close Button -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" FontSize="30" FontWeight="Bold" Foreground="white">App Settings</TextBlock>
                        <Button Grid.Column="1" Style="{StaticResource CloseSettingsButtonStyle}"/>
                    </Grid>

                    <Separator Margin="0,10,0,30" Background="White"/>

                    <!-- settings grid -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*"/>

                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition />
                            <RowDefinition />
                            <RowDefinition Height="50" />
                            <RowDefinition Height="Auto" MinHeight="26" />
                            <RowDefinition Height="Auto" MinHeight="32.96"/>
                        </Grid.RowDefinitions>

                        <!-- Settings -->
                        <Label Grid.Column="0" VerticalAlignment="Center" Foreground="{StaticResource TextPrimaryBrush}" FontSize="18" Margin="0,0,89,0" Grid.ColumnSpan="2" Height="34">Enable Ping</Label>
                        <usercontrols:ToggleButton Grid.Column="1" Grid.Row="0" IsOn="{Binding DataContext.IsPingServiceRunning, ElementName=RackWindow, Mode=TwoWay}" HorizontalAlignment="Left" Margin="14,10,0,10" Width="75" Command="{Binding DataContext.TogglePingServiceCommand, ElementName=RackWindow}"/>

                        <Label Grid.Column="0" Grid.Row="1" VerticalAlignment="Center" Foreground="{StaticResource TextPrimaryBrush}" FontSize="18" Margin="0,0,89,0" Grid.ColumnSpan="2" Height="34">Wake on Lan</Label>
                        <usercontrols:ToggleButton Grid.Column="1" Grid.Row="1" IsOn="{Binding DataContext.IsWoLServiceRunning, ElementName=RackWindow, Mode=TwoWay}" Margin="14,10,0,10" HorizontalAlignment="Left" Width="75" Command="{Binding DataContext.ToggleWoLServiceCommand, ElementName=RackWindow}"/>

                        <Label Grid.Column="0" Grid.Row="2" VerticalAlignment="Center" Foreground="{StaticResource TextPrimaryBrush}" FontSize="18" Margin="0,0,89,0" Grid.ColumnSpan="2" Height="34"># of Rack U's</Label>

                        <!-- Rack Unit Update -->
                        <Grid Grid.Column="1" Grid.Row="2" Margin="0,10,0,10" HorizontalAlignment="Center" Width="89">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBox Grid.Column="0" Grid.RowSpan="2"
                                     Text="{Binding DataContext.NumberOfUnits, ElementName=RackWindow, UpdateSourceTrigger=LostFocus}"
                                     FontSize="15"
                                     KeyDown="NumberOfUnits_KeyDown"
                                     Width="75" Height="35"
                                     VerticalAlignment="Center" HorizontalAlignment="Center"
                                     Background="#333" Foreground="White" BorderBrush="#555" CaretBrush="White"/>
                            <Button Grid.Column="1" Grid.Row="0" Content="▲" Click="Unit_Up_Button_Click" MinHeight="15"/>
                            <Button Grid.Column="1" Grid.Row="1" Content="▼" Click="Unit_Down_Button_Click" MinHeight="15"/>

                        </Grid>
                        <Label Grid.Column="1" Grid.Row="3" Foreground="{StaticResource TextPrimaryBrush}" HorizontalAlignment="Left" Margin="41,0,0,0" Width="48">
                            <Label.Style>
                                <Style TargetType="Label">
                                    <Setter Property="Content" Value="[Unset]"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasEncryptedPassword}" Value="True">
                                            <Setter Property="Content" Value="[Set]"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Label.Style>
                        </Label>
                        <Button Grid.Column="0" Grid.Row="3" x:Name="CredentialsButton" 
                    Command="{Binding OpenGlobalCredentialsPopupCommand}" HorizontalAlignment="Left" MinWidth="80" 
 Background=            "{StaticResource AccentBrush}" Foreground="White" BorderThickness="0" Width="105">

                            <StackPanel Orientation="Horizontal">
                                <iconPacks:PackIconFontAwesome6 Kind="KeySolid" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{StaticResource TextSecondaryBrush}"/>
                                <TextBlock Text="Set Credentials" />
                            </StackPanel>
                        </Button>
                        <Popup IsOpen="{Binding IsGlobalCredentialsPopupOpen}"
                           Placement="Center"
                           AllowsTransparency="True"
                           StaysOpen="True"
                           PopupAnimation="Fade" Grid.ColumnSpan="2" Margin="0,0,89,20">
                            <!-- Add Drop Shadow Effect for visual separation -->
                            <Popup.Effect>
                                <DropShadowEffect Color="Black" ShadowDepth="5" BlurRadius="10" Opacity="0.5"/>
                            </Popup.Effect>
                            <!-- The Credentials Input UserControl -->
                            <usercontrols:CredentialsInputControl Width="300"/>
                        </Popup>
                        <Button Grid.Row="4" Command="{Binding ShutdownAllPCs}"  HorizontalAlignment="Left" Margin="0,15,0,0"
                        Background="{StaticResource AccentBrush}" Foreground="White" BorderThickness="0">Shutdown All</Button>

                    </Grid>
                </StackPanel>
            </Border>

            <!-- Main Content (Rack View - Column 1) -->
            <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="2" CornerRadius="5" Background="{StaticResource AppBackgroundBrush}">
                <!-- Style controls Grid.Column and Grid.ColumnSpan based on BOTH panels -->
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Grid.Column" Value="1"/>
                        <!-- Default: Middle column -->
                        <Setter Property="Margin" Value="0"/>
                        <Style.Triggers>
                            <!-- Settings Closed, Details Closed -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding DataContext.IsSettingsPanelOpen, ElementName=RackWindow}" Value="False"/>
                                    <Condition Binding="{Binding DataContext.IsDetailsPanelOpen, ElementName=RackWindow}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Grid.Column" Value="0"/>
                                <Setter Property="Grid.ColumnSpan" Value="3"/>
                                <Setter Property="Margin" Value="40,0,0,0"/>
                                <!-- Offset for Open Settings Button -->
                            </MultiDataTrigger>
                            <!-- Settings Open, Details Closed -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding DataContext.IsSettingsPanelOpen, ElementName=RackWindow}" Value="True"/>
                                    <Condition Binding="{Binding DataContext.IsDetailsPanelOpen, ElementName=RackWindow}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Grid.Column" Value="1"/>
                                <Setter Property="Grid.ColumnSpan" Value="2"/>
                                <!-- Span middle and right -->
                                <Setter Property="Margin" Value="0"/>
                            </MultiDataTrigger>
                            <!-- Settings Closed, Details Open -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding DataContext.IsSettingsPanelOpen, ElementName=RackWindow}" Value="False"/>
                                    <Condition Binding="{Binding DataContext.IsDetailsPanelOpen, ElementName=RackWindow}" Value="True"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Grid.Column" Value="0"/>
                                <!-- Start at left -->
                                <Setter Property="Grid.ColumnSpan" Value="2"/>
                                <!-- Span left and middle -->
                                <Setter Property="Margin" Value="40,0,0,0"/>
                                <!-- Offset for Open Settings Button -->
                            </MultiDataTrigger>
                            <!-- Settings Open, Details Open (Default Style handles this: Col 1, Span 1) -->
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <!-- Internal Grid for Headers + Content -->
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Row 0: Headers -->
                        <RowDefinition Height="*"/>
                        <!-- Row 1: ScrollViewer -->
                    </Grid.RowDefinitions>

                    <!-- Headers Grid (Moved from outside) -->
                    <Grid Grid.Row="0" Margin="10,10,10,0">
                        <!-- ... (Headers Grid Content remains the same) ... -->
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="35"/>
                            <!-- Matched to DataTemplate width -->
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- U # TextBlock -->
                        <Border Grid.Column="0"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="0,0,0,2"
                                VerticalAlignment="Bottom" Margin="5,0,5,0">
                            <TextBlock FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Bottom" FontSize="20" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,5">U#</TextBlock>
                        </Border>

                        <!-- Slot A TextBlock -->
                        <Border Grid.Column="1"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="0,0,0,2"
                                VerticalAlignment="Bottom" Margin="5,0,5,0">
                            <TextBlock FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Bottom" FontSize="20" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,5">Slot A</TextBlock>
                        </Border>

                        <!-- Slot B TextBlock -->
                        <Border Grid.Column="2"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="0,0,0,2"
                                VerticalAlignment="Bottom" Margin="5,0,5,0">
                            <TextBlock FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Bottom" FontSize="20" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,5">Slot B</TextBlock>
                        </Border>

                        <!-- Slot C TextBlock -->
                        <Border Grid.Column="3"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="0,0,0,2"
                                VerticalAlignment="Bottom" Margin="5,0,5,0">
                            <TextBlock FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Bottom" FontSize="20" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,5">Slot C</TextBlock>
                        </Border>
                    </Grid>

                    <!-- Main Content Scroller -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="10,0,10,10">
                        <!-- Changed to Visible -->
                        <ItemsControl  x:Name="MainRackItemsControl" ItemsSource="{Binding DataContext.RackUnits, ElementName=RackWindow}"
                                      ItemTemplate="{StaticResource UnifiedRackUnitTemplate}"/>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- NEW: Device Details Panel (Column 2) -->
            <Border Grid.Column="2" BorderBrush="{StaticResource AccentBrush}" BorderThickness="3,0,0,0" Width="400"
                    Background="{StaticResource PanelBackgroundBrush}">
                <!-- Match settings panel background -->
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <!-- Default hidden -->
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding DataContext.IsDetailsPanelOpen, ElementName=RackWindow}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <!-- Host the UserControl -->
                <usercontrols:DeviceDetailsView DataContext="{Binding DataContext.SelectedDeviceDetails, ElementName=RackWindow}"/>
            </Border>

        </Grid>
    </DockPanel>
</Window>